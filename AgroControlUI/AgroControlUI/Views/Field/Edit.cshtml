@model AgroControlUI.DTOs.FarmData.CreateFieldDto
<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.css" rel="stylesheet">
<link rel="stylesheet" href="~/css/add.css">
<link rel="stylesheet" href="~/css/addWithSelects.css" />
<link rel="stylesheet" href="~/css/map.css" />


<div class="form-container">
    <div class="blue-form">
        <form asp-action="Edit" method="post">
            <h1>Edytuj pole</h1>

            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <div class="group">
                <input asp-for="Name" value="@Model.Name"/>
                <span class="bar"></span>
                <label asp-for="Name">Nazwa</label>
                <span asp-validation-for="Name" class="text-danger"></span>
            </div>
            <div class="multi-dropdown">
                <select asp-for="SoilTypesIds" asp-items="ViewBag.SoilTypes" id="multipleSelect" multiple> 
                </select>
                <span class="bar"></span>
                <label asp-for="SoilTypesIds">Klasa gleby</label>
                <span asp-validation-for="SoilTypesIds" class="text-danger"></span>
            </div>
            <div class="group">
                <textarea asp-for="Description" class="description-field" value="@Model.Description"></textarea>
                <span class="bar"></span>
                <label asp-for="Description">Opis*</label>
                <span asp-validation-for="Description" class="text-danger"></span>
            </div>

            <!-- Podgląd mapy -->
            <div class="group map">
                <div class="map-preview" id="mapPreview" style="height: 200px;"></div>
            </div>
            <!-- Ukryte pole, w którym zapiszemy współrzędne -->
            <input type="hidden" id="FieldBorder" name="FieldBorder" value="@Model.FieldBorder"/>

            <div class="action-buttons" style="margin-bottom:30px;padding-top:15px;">
                <button type="button" class="edit-btn" data-bs-toggle="modal" data-bs-target="#mapModal">
                    Edytuj granice
                </button>
                <button type="button" class="delete-btn" id="clearBorders" data-bs-toggle="modal" data-bs-target="#mapModal">
                    Usuń granice
                </button>
            </div>
            <div class="group">
                <input asp-for="Area" type="number" step="0.01" required data-val-number="Powierzchnia musi być liczbą." oninput="validateInput(event)" />
                <span class="bar"></span>
                <label asp-for="Area">Powierzchnia (ha)</label>
                <span asp-validation-for="Area" class="text-danger"></span>
            </div>
            <div style="margin-bottom:20px;margin-top:-35px">
                <span>* - pole opcjonalne</span>
            </div>
            <div class="action-buttons">
                <a asp-action="Index" class="cancel-btn">Anuluj</a>
                <button type="submit" class="add-btn">Zapisz</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal with Map -->
<div class="modal fade" id="mapModal" tabindex="-1" aria-labelledby="mapModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mapModalLabel">Edytuj granice pola</h5>
            </div>
            <div class="modal-body">
                <div id="map" style="height: 500px;"></div>
            </div>

            <!-- Legenda mapy -->
            <div class="modal-footer">
                <button type="button" style="width:100%" class="add-btn" data-bs-dismiss="modal">Zapisz</button>
            </div>
        </div>
    </div>
</div>
<script src="~/js/inputLabel.js"></script>
<!-- Leaflet + Leaflet Draw JS/CSS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>

<script>
           document.addEventListener("DOMContentLoaded", function () {
        var selectedSoilTypesIds = @Html.Raw(Json.Serialize(Model.SoilTypesIds));
        console.log('selectedSoilTypesIds:', selectedSoilTypesIds);

        // Inicjalizacja TomSelect
        new TomSelect("#multipleSelect", {
            plugins: {
                remove_button: {
                    title: "Usuń",
                },
            },
            setValue: selectedSoilTypesIds
        });

        var areaInput = document.getElementById("Area");
        var clearBordersBtn = document.getElementById("clearBorders");
        var fieldBorderInput = document.getElementById("FieldBorder");

        var map, previewMap;
        var drawnItemsPreview = new L.FeatureGroup();
        var drawnItemsModal = new L.FeatureGroup();
        var fieldBorderData = fieldBorderInput.value ? JSON.parse(fieldBorderInput.value) : null;
        var areaLabel;
        var initialLat = 52.2297, initialLng = 21.0122;
        var postalCode = '@ViewBag.PostalCode';

        // Geokodowanie kodu pocztowego
        function geocodePostalCode(postalCode) {
            return fetch(`https://nominatim.openstreetmap.org/search?postalcode=${postalCode}&format=json&country=Poland`)
                .then(response => response.json())
                .then(data => data.length > 0 ? [parseFloat(data[0].lat), parseFloat(data[0].lon)] : [initialLat, initialLng])
                .catch(error => {
                    console.error('Geocoding failed:', error);
                    return [initialLat, initialLng];
                });
        }

        // Inicjalizacja podglądu mapy
        previewMap = L.map('mapPreview', { zoomControl: false, dragging: true }).setView([initialLat, initialLng], 13);
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '© Esri'
        }).addTo(previewMap);
        previewMap.addLayer(drawnItemsPreview);

        // Jeśli mamy kod pocztowy, ustawiamy mapę na tę lokalizację
        if (postalCode) {
            geocodePostalCode(postalCode).then(coords => {
                initialLat = coords[0];
                initialLng = coords[1];
                previewMap.setView([initialLat, initialLng], 13);
            });
        }

        // Blokowanie pola powierzchni, jeśli istnieją granice
        function lockAreaInput(value) {
            areaInput.setAttribute("readonly", true);
            areaInput.value = value;
            areaInput.style.backgroundColor = "#e9ecef";
            areaInput.style.cursor = "not-allowed";
        }

        function unlockAreaInput() {
            areaInput.removeAttribute("readonly");
            areaInput.value = "";
            areaInput.style.backgroundColor = "";
            areaInput.style.cursor = "";
        }

        // Jeśli istnieje pole, blokujemy powierzchnię od razu
        if (fieldBorderData) {
            lockAreaInput(calculateArea(fieldBorderData));
            syncPreviewMap(fieldBorderData);
        }

        // Obsługa kliknięcia w podgląd mapy
        document.getElementById("mapPreview").addEventListener("click", function () {
            $('#mapModal').modal('show');
        });

        // Inicjalizacja mapy w modalu
        $('#mapModal').on('shown.bs.modal', function () {
            if (map) {
                map.invalidateSize();
                return;
            }

            map = L.map('map', { zoomControl: true, dragging: true }).setView([initialLat, initialLng], 13);
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© Esri'
            }).addTo(map);
            map.addLayer(drawnItemsModal);

            var drawControl = new L.Control.Draw({
                draw: {
                    polyline: false,
                    rectangle: false,
                    circle: false,
                    marker: false,
                    circlemarker: false,
                    polygon: {
                        allowIntersection: false,
                        showArea: true,
                        drawError: {
                            color: '#e1e100',
                            message: '<strong>Błąd:</strong> Granice nie mogą się przecinać!'
                        }
                    }
                },
                edit: {
                    featureGroup: drawnItemsModal,
                    remove: true
                }
            });

            map.addControl(drawControl);

            // Jeśli istnieją granice pola, dodajemy je na mapę
            if (fieldBorderData) {
                var geoJsonLayer = L.geoJSON(fieldBorderData);
                drawnItemsModal.clearLayers();
                drawnItemsModal.addLayer(geoJsonLayer);
                map.fitBounds(geoJsonLayer.getBounds());
            }

            map.on(L.Draw.Event.CREATED, function (e) {
                var layer = e.layer;
                drawnItemsModal.clearLayers();
                drawnItemsModal.addLayer(layer);

                fieldBorderData = layer.toGeoJSON().geometry;
                fieldBorderInput.value = JSON.stringify(fieldBorderData);

                updateAreaLabel(layer);
                lockAreaInput(areaInput.value);
                syncPreviewMap(fieldBorderData);
            });

            map.on(L.Draw.Event.EDITED, function (e) {
                e.layers.eachLayer(function (layer) {
                    fieldBorderData = layer.toGeoJSON().geometry;
                    fieldBorderInput.value = JSON.stringify(fieldBorderData);
                    updateAreaLabel(layer);
                    lockAreaInput(areaInput.value);
                    syncPreviewMap(fieldBorderData);
                });
            });

            // Usuwanie granic
            map.on(L.Draw.Event.DELETED, function () {
                fieldBorderData = null;
                fieldBorderInput.value = "";
                drawnItemsPreview.clearLayers();
                unlockAreaInput();

                if (areaLabel) {
                    map.removeLayer(areaLabel);
                }
            });
        });

        function calculateArea(geometry) {
            var areaInMeters = turf.area(geometry);
            return (areaInMeters / 10000).toFixed(2);
        }

        function updateAreaLabel(layer) {
            var area = calculateArea(layer.toGeoJSON().geometry);
            document.getElementById("Area").value = area;

            if (areaLabel) {
                map.removeLayer(areaLabel);
            }

            areaLabel = L.marker(layer.getBounds().getCenter(), {
                icon: L.divIcon({
                    className: 'area-label',
                    html: `${area} ha`,
                    iconSize: [120, 30],
                    iconAnchor: [60, 15],
                    popupAnchor: [0, -15],
                    className: 'area-label no-scaling'
                })
            }).addTo(map);
        }

            function syncPreviewMap(geoJsonData) {
        if (!geoJsonData) return;

        drawnItemsPreview.clearLayers();

        var geoJsonLayer = L.geoJSON(geoJsonData);
        drawnItemsPreview.addLayer(geoJsonLayer);

        var bounds = geoJsonLayer.getBounds();
        if (bounds.isValid()) {
            previewMap.fitBounds(bounds, { padding: [20, 20] });
        }
    }

    // Jeśli istnieją granice pola, zsynchronizuj podgląd
    if (fieldBorderData) {
        setTimeout(() => syncPreviewMap(fieldBorderData), 500);
    }

        clearBordersBtn.addEventListener("click", function () {
            fieldBorderData = null;
            fieldBorderInput.value = "";
            drawnItemsPreview.clearLayers();
            drawnItemsModal.clearLayers();
            unlockAreaInput();

            if (areaLabel) {
                map.removeLayer(areaLabel);
            }
        });

        clearBordersBtn.removeAttribute("data-bs-toggle");
        clearBordersBtn.removeAttribute("data-bs-target");
    });


</script>
