@model AgroControlUI.DTOs.FieldWorks.CreateFertilizingWorkDto

<link rel="stylesheet" href="~/css/add.css" />
<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.css" rel="stylesheet" />
<link rel="stylesheet" href="~/css/addWithSelects.css" />
<link rel="stylesheet" href="~/css/colors.css" />
<link rel="stylesheet" href="~/css/selectWithInput.css" />
<style>
    .adding-input {
    width: 18%;
    height: 46px;
    }
    .adding-select {
    width: 49%;
    }
    .adding-unit{
    width:18%;
    }
</style>
<div class="form-container">
    <div class="green-form">
        <form asp-action="CreateFertilizingWork" method="post">
            @Html.AntiForgeryToken()
            <h1>Dodaj pracę nawożenia</h1>

            <div class="single-dropdown">
                <select asp-for="FieldId" asp-items="ViewBag.Fields" id="fieldSelect" required>
                    <option value=""></option>
                </select>
                <span class="bar"></span>
                <label asp-for="FieldId">Pole</label>
                <span asp-validation-for="FieldId" class="text-danger"></span>
            </div>
            @if(!User.IsInRole("Pracownik"))
            {
                <div class="single-dropdown">
                    <select id="workerSelect" name="workerSelect">
                        <option value="">Wybierz pracownika</option>
                        <optgroup label="Pracownicy">
                            @foreach (var employee in ViewBag.Employees)
                            {
                                <option value="@employee.Value" data-type="employee">@employee.Text</option>
                            }
                        </optgroup>
                        <optgroup label="Użytkownicy systemowi">
                            @foreach (var user in ViewBag.Users)
                            {
                                <option value="@user.Value" data-type="user">@user.Text</option>
                            }
                        </optgroup>
                    </select>
                    <span class="bar"></span>
                    <label>Pracownik</label>
                    <span asp-validation-for="EmployeeId" class="text-danger"></span>
                </div>
                <input asp-for="EmployeeId" type="hidden" id="EmployeeId" name="EmployeeId" />
                <input asp-for="AgroControlUserId" type="hidden" id="AgroControlUserId" name="AgroControlUserId" />

            }
            <input type="hidden" id="EmployeeId" name="EmployeeId" />
            <input type="hidden" id="AgroControlUserId" name="AgroControlUserId" />
            <div class="multi-dropdown">
                <select asp-for="FieldWorkAgriculturalEquipmentIds"  asp-items="ViewBag.AgriculturalEquipment" id="agricultrualEquipmentSelect" multiple></select>
                <span class="bar"></span>
                <label asp-for="FieldWorkAgriculturalEquipmentIds">Użyte maszyny</label>
                <span asp-validation-for="FieldWorkAgriculturalEquipmentIds" class="text-danger"></span>
            </div>
            
            <div class="group">
                <input asp-for="StartTime" type="datetime-local" />
                <span class="bar"></span>
                <label asp-for="StartTime">Data rozpoczęcia</label>
                <span asp-validation-for="StartTime" class="text-danger"></span>
            </div>

            <div class="group">
                <input asp-for="EndTime" type="datetime-local" />
                <span class="bar"></span>
                <label asp-for="EndTime">Data zakończenia*</label>
                <span asp-validation-for="EndTime" class="text-danger"></span>
            </div>

            <div class="single-dropdown">
                <div id="adding-container" class="adding-container"></div>
                @if (TempData["ActiveIngredientErrors"] != null)
                {
                    <span class="text-danger">
                        @TempData["ActiveIngredientErrors"]
                    </span>
                }
                <button type="button" id="add-ingredient">Dodaj nawóz</button>
            </div>

            <div class="group">
                <textarea asp-for="Description" class="description-field"></textarea>
                <span class="bar"></span>
                <label asp-for="Description">Opis*</label>
                <span asp-validation-for="Description" class="text-danger"></span>
            </div>

            <div style="margin-bottom:20px;margin-top:-35px">
                <span>* - pole opcjonalne</span>
            </div>

            <div class="action-buttons">
                <a asp-action="Index" class="cancel-btn">Anuluj</a>
                <button type="submit" class="add-btn">Dodaj</button>
            </div>
        </form>
    </div>
</div>

<select id="unitOptions" style="display:none">
    @foreach (var unit in ViewBag.Units)
    {
        <option value="@unit.Value">@unit.Text</option>
    }
</select>

<select id="fertilizerOptions" style="display:none">
    @foreach (var fertilizer in ViewBag.Fertilizers)
    {
        <option value="@fertilizer.Value">@fertilizer.Text</option>
    }
</select>

<script src="~/js/inputLabel.js"></script>
<script src="~/js/listOperations.js"></script>
<script src="~/lib/jquery-validation/jquery.validate.min.js"></script>
<script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
<script>

    let isUpdatingOptions = false;

    function getOriginalOptions() {
        const compSelect = document.getElementById("fertilizerOptions");
        return Array.from(compSelect.options).map(opt => ({
            value: opt.value,
            text: opt.text
        }));
    }

    function updateAvailableOptions() {
        // Jeśli już trwa aktualizacja, kończymy
        if (isUpdatingOptions) return;
        isUpdatingOptions = true;

        const originalOptions = getOriginalOptions();
        const allSelects = document.querySelectorAll("select.ingredient-select");

        allSelects.forEach(select => {
            const instance = select.tomselect;
            const currentValue = instance.getValue();
            const selectedValuesOther = new Set();

            allSelects.forEach(s => {
                if (s !== select) {
                    const val = s.tomselect.getValue();
                    if (val !== "") {
                        selectedValuesOther.add(val);
                    }
                }
            });

            // Budujemy nową listę opcji:
            let newOptions = [];
            originalOptions.forEach(opt => {
                if (!selectedValuesOther.has(opt.value) || opt.value === currentValue) {
                    newOptions.push(opt);
                }
            });

            // Aktualizujemy instancję TomSelect
            instance.clearOptions();
            instance.addOption(newOptions);
            instance.refreshOptions(false);
            if (currentValue !== "") {
                instance.setValue(currentValue);
            } else {
                instance.clear();
            }
        });

        isUpdatingOptions = false;
    }

    // Nasłuchiwanie zmian w selectach ingredient-select
    document.addEventListener("change", (event) => {
        if (event.target.matches("select.ingredient-select")) {
            updateAvailableOptions();
        }
    });

    // Wywołaj updateAvailableOptions() na starcie
    updateAvailableOptions();

    document.addEventListener("DOMContentLoaded", function () {

        new TomSelect("#fieldSelect", { create: false, sortField: "text", placeholder: "Wyszukaj...", plugins: ['remove_button'] });
        new TomSelect("#agricultrualEquipmentSelect", { create: false, sortField: "text", placeholder: "Wyszukaj...", plugins: ['remove_button'] });
        if (document.getElementById("workerSelect")) {
        new TomSelect("#workerSelect", {
            create: false,
            sortField: "text",
            placeholder: "Wyszukaj...",
            plugins: ['remove_button']
        });
        }

        const addIngredientButton = document.getElementById("add-ingredient");
        const container = document.getElementById("adding-container");
        const fertilizerOptions = document.getElementById("fertilizerOptions").innerHTML;

        function createIngredientRow() {
            const wrapper = document.createElement("div");
            wrapper.classList.add("adding-wrapper");

            const selectWrapper = document.createElement("div");
            selectWrapper.classList.add("group", "adding-select");

            const select = document.createElement("select");
            select.classList.add("ingredient-select");
            select.required = false;
            const currentIndex = container.children.length;
            select.name = `FertilizingWorkFertilizers[${currentIndex}].FertilizerId`;

            const selectBar = document.createElement("span");
            selectBar.classList.add("bar");

            const selectLabel = document.createElement("label");
            selectLabel.textContent = "Nawóz";
     
            select.innerHTML = `<option value="" selected disabled>Wybierz składnik nawozu</option>` + fertilizerOptions;

            selectWrapper.appendChild(select);
            selectWrapper.appendChild(selectBar);
            selectWrapper.appendChild(selectLabel);

            const inputWrapper = document.createElement("div");
            inputWrapper.classList.add("group", "adding-input");

            const input = document.createElement("input");
            input.type = "number";
            input.required = false;
            input.name = `FertilizingWorkFertilizers[${currentIndex}].ElementPercentage`;

            const inputBar = document.createElement("span");
            inputBar.classList.add("bar");

            const inputLabel = document.createElement("label");
            inputLabel.textContent = "Ilość(/ha)";

            inputWrapper.appendChild(input);
            inputWrapper.appendChild(inputBar);
            inputWrapper.appendChild(inputLabel);

            const unitWrapper = document.createElement("div");
            unitWrapper.classList.add("group", "adding-unit");

            const unitSelect = document.createElement("select");
            unitSelect.classList.add("unit-select");
            unitSelect.name = `FertilizingWorkFertilizers[${currentIndex}].UnitId`;

            unitSelect.innerHTML = `<option value="" selected disabled></option>` + document.getElementById("unitOptions").innerHTML;

            const unitBar = document.createElement("span");
            unitBar.classList.add("bar");

            const unitLabel = document.createElement("label");
            unitLabel.textContent = "Jedn.";

            unitWrapper.appendChild(unitSelect);
            unitWrapper.appendChild(unitBar);
            unitWrapper.appendChild(unitLabel);

            // Przycisk usuwania
            const removeButton = document.createElement("button");
            removeButton.type = "button";
            removeButton.classList.add("remove-row");
            removeButton.textContent = "X";

            removeButton.addEventListener("click", function () {
                wrapper.remove();
                updateAvailableOptions();
                toggleRemoveButtons();
                updateIndexes();
            });

            // Dodanie elementów do wrappera i kontenera
            wrapper.append(selectWrapper, inputWrapper,unitWrapper, removeButton);
            container.appendChild(wrapper);

            // Inicjalizacja TomSelect dla nowego selecta
            new TomSelect(select, {
                create: false,
                sortField: "text",
                placeholder: "Wyszukaj..."
            });

            new TomSelect(unitSelect, {
            create: false,
            sortField: "text"
            });

            input.addEventListener("input", function () {
        if (input.value.trim() !== "") {
            input.classList.add("filled");
        } else {
            input.classList.remove("filled");
        }
    });

    input.addEventListener("blur", function () {
        const validationError = input.closest('.group').querySelector('.input-validation-error');
        if (validationError) {
            input.classList.add("filled");
        } else {
            if (input.value.trim() !== "") {
                input.classList.add("filled");
            } else {
                input.classList.remove("filled");
            }
        }
    });
            updateIndexes();
            updateAvailableOptions();
            toggleRemoveButtons();
        }
        function updateIndexes() {
            const allSelects = container.querySelectorAll("select.ingredient-select");
            const allInputs = container.querySelectorAll("input[type='number']");
            const allUnits = document.querySelectorAll(".adding-wrapper select.unit-select");

            allSelects.forEach((select, idx) => {
                select.name = `FertilizingWorkFertilizers[${idx}].FertilizerId`;
            });
            allInputs.forEach((input, idx) => {
                input.name = `FertilizingWorkFertilizers[${idx}].Quantity`;
            });
            allUnits.forEach((unit, idx) => {
                unit.name = `FertilizingWorkFertilizers[${idx}].UnitId`;
            });
        }
            function toggleRemoveButtons() {
        const removeButtons = container.querySelectorAll(".remove-row");
        const isOnlyOneLeft = removeButtons.length === 1;

        removeButtons.forEach(btn => {
            if (isOnlyOneLeft) {
                btn.style.visibility = "hidden";
                btn.style.opacity = "0";
                btn.style.pointerEvents = "none";
            } else {
                btn.style.visibility = "visible";
                btn.style.opacity = "1";
                btn.style.pointerEvents = "auto";
            }
        });
    }

        addIngredientButton.addEventListener("click", createIngredientRow);
        createIngredientRow(); 
    });
                document.getElementById('workerSelect').addEventListener('change', function() {
        var selectedOption = this.options[this.selectedIndex];
        var selectedValue = selectedOption.value;
        var selectedType = selectedOption.getAttribute('data-type');

        if (selectedValue) {
            if (selectedType === 'employee') {
                document.getElementById('EmployeeId').value = selectedValue;
                document.getElementById('AgroControlUserId').value = ''; 
            } else if (selectedType === 'user') {
                document.getElementById('AgroControlUserId').value = selectedValue; 
                document.getElementById('EmployeeId').value = ''; 
            }
        } else {
            document.getElementById('EmployeeId').value = '';
            document.getElementById('AgroControlUserId').value = '';
        }
    });
</script>
