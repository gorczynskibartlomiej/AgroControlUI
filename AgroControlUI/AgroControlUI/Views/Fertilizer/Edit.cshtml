@model AgroControlUI.DTOs.Fertilizers.CreateFertilizerDto

<link rel="stylesheet" href="~/css/add.css" />
<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.css" rel="stylesheet" />
<link rel="stylesheet" href="~/css/addWithSelects.css" />
<link rel="stylesheet" href="~/css/colors.css" />
<link rel="stylesheet" href="~/css/selectWithInput.css" />

<div class="form-container">
    <div class="green-form">
        <form asp-action="Edit" method="post">
            <h1>Edytuj nawóz</h1>
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <div class="group">
                <input asp-for="Name" />
                <span class="bar"></span>
                <label asp-for="Name">Nazwa nawozu</label>
                <span asp-validation-for="Name" class="text-danger"></span>
            </div>

            <div class="single-dropdown">
                <select asp-for="ProducerId" asp-items="ViewBag.Producers" id="producerSelect">
                    <option value="">Wybierz producenta</option>
                </select>
                <span class="bar"></span>
                <label asp-for="ProducerId">Producent</label>
                <span asp-validation-for="ProducerId" class="text-danger"></span>
            </div>

            <div class="single-dropdown">
                <select asp-for="CategoryId" asp-items="ViewBag.Categories" id="categorySelect">
                    <option value="">Wybierz kategorię nawozu</option>
                </select>
                <span class="bar"></span>
                <label asp-for="CategoryId">Kategoria nawozu</label>
                <span asp-validation-for="CategoryId" class="text-danger"></span>
            </div>
            <div class="single-dropdown">
                <div id="adding-container" class="adding-container"></div>
                @if (TempData["ComponentsErrors"] != null)
                {
                    <span class="text-danger">
                        @TempData["ComponentsErrors"]
                    </span>
                }
                <button type="button" id="add-ingredient">Dodaj kolejny</button>
            </div>
            <div class="group">
                <textarea asp-for="Description" class="description-field"></textarea>
                <span class="bar"></span>
                <label asp-for="Description">Opis</label>
                <span asp-validation-for="Description" class="text-danger"></span>
            </div>

            <div class="action-buttons">
                <a asp-action="Index" class="cancel-btn">Anuluj</a>
                <button type="submit" class="add-btn">Zapisz</button>
            </div>
        </form>
    </div>
</div>

<!-- Ukryta lista składników nawozu -->
<select id="componentOptions" style="display:none">
    @foreach (var option in ViewBag.ChemicalElements)
    {
        <option value="@option.Value">@option.Text</option>
    }
</select>

<script src="~/lib/jquery-validation/jquery.validate.min.js"></script>
<script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
<script src="~/js/inputLabel.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
<script>
    let isUpdatingOptions = false;

    function getOriginalOptions() {
        const compSelect = document.getElementById("componentOptions");
        return Array.from(compSelect.options).map(opt => ({
            value: opt.value,
            text: opt.text
        }));
    }

    function updateAvailableOptions() {
        if (isUpdatingOptions) return;
        isUpdatingOptions = true;

        const originalOptions = getOriginalOptions();
        const allSelects = document.querySelectorAll("select.ingredient-select");

        allSelects.forEach(select => {
            const instance = select.tomselect;
            const currentValue = instance.getValue();
            const selectedValuesOther = new Set();

            allSelects.forEach(s => {
                if (s !== select) {
                    const val = s.tomselect.getValue();
                    if (val !== "") {
                        selectedValuesOther.add(val);
                    }
                }
            });

            let newOptions = [];
            newOptions.push({ value: "", text: "Wybierz składnik aktywny" });
            originalOptions.forEach(opt => {
                if (!selectedValuesOther.has(opt.value) || opt.value === currentValue) {
                    newOptions.push(opt);
                }
            });

            instance.clearOptions();
            instance.addOption(newOptions);
            instance.refreshOptions(false);
            if (currentValue !== "") {
                instance.setValue(currentValue);
            } else {
                instance.clear();
            }
        });

        isUpdatingOptions = false;
    }

    document.addEventListener("change", (event) => {
        if (event.target.matches("select.ingredient-select")) {
            updateAvailableOptions();
        }
    });

    updateAvailableOptions();

    document.addEventListener("DOMContentLoaded", function () {
        new TomSelect("#producerSelect", { create: false, sortField: "text", placeholder: "Wybierz producenta" });
        new TomSelect("#categorySelect", { create: false, sortField: "text", placeholder: "Wyszukaj..." });

        const addIngredientButton = document.getElementById("add-ingredient");
        const container = document.getElementById("adding-container");
        const componentOptions = document.getElementById("componentOptions").innerHTML;

        function createIngredientRow(chemicalElementId = null, elementPercentage = null) {
            const wrapper = document.createElement("div");
            wrapper.classList.add("adding-wrapper");

            const selectWrapper = document.createElement("div");
            selectWrapper.classList.add("group", "adding-select");

            const select = document.createElement("select");
            select.classList.add("ingredient-select");
            select.required = false;
            select.setAttribute("data-val", "true");
            const currentIndex = container.children.length;
            select.name = `FertilizerComponents[${currentIndex}].ChemicalElementId`;

            const selectBar = document.createElement("span");
            selectBar.classList.add("bar");

            const selectLabel = document.createElement("label");
            selectLabel.textContent = "Składnik nawozu";

            select.innerHTML = `<option value="" selected disabled>Wybierz składnik nawozu</option>` + componentOptions;
            if (chemicalElementId) {
            select.value = chemicalElementId;
            }

            selectWrapper.appendChild(select);
            selectWrapper.appendChild(selectBar);
            selectWrapper.appendChild(selectLabel);

            const inputWrapper = document.createElement("div");
            inputWrapper.classList.add("group", "adding-input");

            const input = document.createElement("input");
            input.type = "number";
            input.required = false;
            input.name = `FertilizerComponents[${currentIndex}].ElementPercentage`;
            input.value = elementPercentage ? parseFloat(elementPercentage).toFixed(2) : "";
            input.setAttribute("data-val", "true");

            const inputBar = document.createElement("span");
            inputBar.classList.add("bar");

            const inputLabel = document.createElement("label");
            inputLabel.textContent = "Zawartość (%)";

            inputWrapper.appendChild(input);
            inputWrapper.appendChild(inputBar);
            inputWrapper.appendChild(inputLabel);

            const removeButton = document.createElement("button");
            removeButton.type = "button";
            removeButton.classList.add("remove-row");
            removeButton.textContent = "X";

            removeButton.addEventListener("click", function () {
                wrapper.remove();
                updateAvailableOptions();
                updateIndexes();
                toggleRemoveButtons();
            });

            wrapper.append(selectWrapper, inputWrapper, removeButton);
            container.appendChild(wrapper);

            const tomSelectInstance = new TomSelect(select, {
                create: false,
                sortField: "text",
                placeholder: "Wyszukaj..."
            });
                if (chemicalElementId) {
        tomSelectInstance.setValue(chemicalElementId);
        }if (input.value.trim() !== "") {
        input.classList.add("filled");
    }
            // Nasłuch zmiany w tym selectie
            select.addEventListener("change", updateAvailableOptions);

            input.addEventListener("input", function () {
        if (input.value.trim() !== "") {
            input.classList.add("filled");
        } else {
            input.classList.remove("filled");
        }
    });

    input.addEventListener("blur", function () {
        const validationError = input.closest('.group').querySelector('.input-validation-error');
        if (validationError) {
            // Jeśli pole ma błąd walidacji, nie usuwamy klasy 'filled'
            input.classList.add("filled");
        } else {
            // Używamy tej samej logiki jak w "input", żeby dodać lub usunąć klasę 'filled'
            if (input.value.trim() !== "") {
                input.classList.add("filled");
            } else {
                input.classList.remove("filled");
            }
        }
    });
            updateIndexes();
            updateAvailableOptions();
            toggleRemoveButtons();
        }

        function updateIndexes() {
            const allSelects = container.querySelectorAll("select.ingredient-select");
            const allInputs = container.querySelectorAll("input[type='number']");

            allSelects.forEach((select, idx) => {
                select.name = `FertilizerComponents[${idx}].ChemicalElementId`;
            });
            allInputs.forEach((input, idx) => {
                input.name = `FertilizerComponents[${idx}].ElementPercentage`;
            });
        }

        function toggleRemoveButtons() {
            const removeButtons = container.querySelectorAll(".remove-row");
            const isOnlyOneLeft = removeButtons.length === 1;

            removeButtons.forEach(btn => {
                if (isOnlyOneLeft) {
                    btn.style.visibility = "hidden";
                    btn.style.opacity = "0";
                    btn.style.pointerEvents = "none";
                } else {
                    btn.style.visibility = "visible";
                    btn.style.opacity = "1";
                    btn.style.pointerEvents = "auto";
                }
            });
        }

        addIngredientButton.addEventListener("click", function () {
            createIngredientRow();
        });

        // Pobieranie istniejących składników nawozu
        const existingComponents = @Html.Raw(Json.Serialize(Model.FertilizerComponents));
        if (existingComponents.length > 0) {
            existingComponents.forEach(component => {
                createIngredientRow(component.chemicalElementId, component.elementPercentage);
            });
        } else {
            createIngredientRow(); // Jeśli brak składników, dodaj jeden pusty wiersz
        }
    });
</script>

