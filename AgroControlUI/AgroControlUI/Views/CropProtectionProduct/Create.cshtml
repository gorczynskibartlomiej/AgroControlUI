@model AgroControlUI.DTOs.CropProtectionProducts.CreateCropProtectionProductDto

<link rel="stylesheet" href="~/css/add.css" />
<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.css" rel="stylesheet" />
<link rel="stylesheet" href="~/css/addWithSelects.css" />
<link rel="stylesheet" href="~/css/colors.css" />
<link rel="stylesheet" href="~/css/selectWithInput.css" />


<div class="form-container">
    <div class="green-form">
        <form asp-action="Create" method="post">
            <h1>Dodaj środek ochrony roślin</h1>
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <!-- Nazwa środka -->
            <div class="group">
                <input asp-for="Name" />
                <span class="bar"></span>
                <label asp-for="Name">Nazwa środka ochrony roślin</label>
                <span asp-validation-for="Name" class="text-danger"></span>
            </div>

            <!-- Producent -->
            <div class="single-dropdown">
                <select asp-for="ProducerId" asp-items="ViewBag.Producers" id="producerSelect">
                    <option value="">Wybierz producenta</option>
                </select>
                <span class="bar"></span>
                <label asp-for="ProducerId">Producent</label>
                <span asp-validation-for="ProducerId" class="text-danger"></span>
            </div>

            <!-- Kategorie -->
            <div class="multi-dropdown">
                <select asp-for="CategoryIds" asp-items="ViewBag.Categories" id="categorySelect" multiple></select>
                <span class="bar"></span>
                <label asp-for="CategoryIds">Kategorie</label>
                <span asp-validation-for="CategoryIds" class="text-danger"></span>
            </div>

            <!-- Rośliny -->
            <div class="multi-dropdown">
                <select asp-for="CropIds" asp-items="ViewBag.Crops" id="cropSelect" multiple></select>
                <span class="bar"></span>
                <label asp-for="CropIds">Rośliny</label>
                <span asp-validation-for="CropIds" class="text-danger"></span>
            </div>

            <!-- Składniki aktywne -->
            <div class="single-dropdown">
                <div id="adding-container" class="adding-container"></div>
                @if (TempData["ActiveIngredientErrors"] != null)
                {
                    <span class="text-danger">
                        @TempData["ActiveIngredientErrors"]
                    </span>
                }
                <button type="button" id="add-ingredient">Dodaj kolejny</button>
            </div>
            <!-- Opis -->
            <div class="group">
                <textarea asp-for="Description" class="description-field"></textarea>
                <span class="bar"></span>
                <label asp-for="Description">Opis*</label>
                <span asp-validation-for="Description" class="text-danger"></span>
            </div>
            <div style="margin-bottom:20px;margin-top:-35px">
                <span>* - pole opcjonalne</span>
            </div>
            
            <div class="action-buttons">
                <a asp-action="Index" class="cancel-btn">Anuluj</a>
                <button type="submit" class="add-btn">Dodaj</button>
            </div>
            
        </form>
    </div>
</div>

<!-- Ukryta lista składników aktywnych -->
<select id="componentOptions" style="display:none">
    @foreach (var option in ViewBag.Components)
    {
        <option value="@option.Value">@option.Text</option>
    }
</select>
<script src="~/lib/jquery-validation/jquery.validate.min.js"></script>
<script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
<script src="~/js/inputLabel.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
<script>
            let isUpdatingOptions = false;

    function getOriginalOptions() {
        const compSelect = document.getElementById("componentOptions");
        return Array.from(compSelect.options).map(opt => ({
            value: opt.value,
            text: opt.text
        }));
    }

    function updateAvailableOptions() {
        // Jeśli już trwa aktualizacja, kończymy
        if (isUpdatingOptions) return;
        isUpdatingOptions = true;

        const originalOptions = getOriginalOptions();
        const allSelects = document.querySelectorAll("select.ingredient-select");

        allSelects.forEach(select => {
            const instance = select.tomselect;
            const currentValue = instance.getValue();
            const selectedValuesOther = new Set();

            allSelects.forEach(s => {
                if (s !== select) {
                    const val = s.tomselect.getValue();
                    if (val !== "") {
                        selectedValuesOther.add(val);
                    }
                }
            });

            // Budujemy nową listę opcji:
            let newOptions = [];
            newOptions.push({ value: "", text: "Wybierz składnik aktywny" });
            originalOptions.forEach(opt => {
                if (!selectedValuesOther.has(opt.value) || opt.value === currentValue) {
                    newOptions.push(opt);
                }
            });

            // Aktualizujemy instancję TomSelect
            instance.clearOptions();
            instance.addOption(newOptions);
            instance.refreshOptions(false);
            if (currentValue !== "") {
                instance.setValue(currentValue);
            } else {
                instance.clear();
            }
        });

        isUpdatingOptions = false;
    }

    // Nasłuchiwanie zmian w selectach ingredient-select
    document.addEventListener("change", (event) => {
        if (event.target.matches("select.ingredient-select")) {
            updateAvailableOptions();
        }
    });

    // Wywołaj updateAvailableOptions() na starcie
    updateAvailableOptions();

    document.addEventListener("DOMContentLoaded", function () {
        // Inicjalizacja TomSelect dla pozostałych dropdownów
        new TomSelect("#producerSelect", { create: false, sortField: "text", placeholder: "Wybierz producenta" });
        new TomSelect("#categorySelect", { create: false, sortField: "text", placeholder: "Wyszukaj...", plugins: ['remove_button'] });
        new TomSelect("#cropSelect", { create: false, sortField: "text", placeholder: "Wyszukaj...", plugins: ['remove_button'] });

        const addIngredientButton = document.getElementById("add-ingredient");
        const container = document.getElementById("adding-container");
        // Pobieranie oryginalnych opcji z ukrytego selecta (jako string, do wstawienia początkowo)
        const componentOptions = document.getElementById("componentOptions").innerHTML;

        // Funkcja tworzenia wiersza składnika
        function createIngredientRow() {
            const wrapper = document.createElement("div");
            wrapper.classList.add("adding-wrapper");

            // Tworzenie selecta dla składnika aktywnego
            const selectWrapper = document.createElement("div");
            selectWrapper.classList.add("group", "adding-select");

            const select = document.createElement("select");
            select.classList.add("ingredient-select");
            select.required = false;
            select.setAttribute("data-val", "true");
            // select.setAttribute("data-val-required", "To pole jest wymagane.");
            // Używamy dynamicznie generowanych nazw dla selectów i inputów
            const currentIndex = container.children.length;
            select.name = `ActiveIngredients[${currentIndex}].ActiveIngredientId`;

            const selectBar = document.createElement("span");
            selectBar.classList.add("bar");

            const selectLabel = document.createElement("label");
            selectLabel.textContent = "Składnik aktywny";

            // Wstawiamy oryginalne opcje wraz z domyślną pustą opcją
            select.innerHTML = `<option value="" selected disabled>Wybierz składnik aktywny</option>` + componentOptions;

            selectWrapper.appendChild(select);
            selectWrapper.appendChild(selectBar);
            selectWrapper.appendChild(selectLabel);

            // Tworzenie inputa dla ilości
            const inputWrapper = document.createElement("div");
            inputWrapper.classList.add("group", "adding-input");

            const input = document.createElement("input");
            input.type = "number";
            // input.min = "0";
            // input.step = "1";
            input.required = false;
            input.name = `ActiveIngredients[${currentIndex}].Concentration`;

            input.setAttribute("data-val", "true");
            // input.setAttribute("data-val-required", "To pole jest wymagane.");
            // input.setAttribute("data-val-number", "Wartość musi być liczbą.");

            const inputBar = document.createElement("span");
            inputBar.classList.add("bar");

            const inputLabel = document.createElement("label");
            inputLabel.textContent = "Ilość (g)";

            inputWrapper.appendChild(input);
            inputWrapper.appendChild(inputBar);
            inputWrapper.appendChild(inputLabel);

            // Przycisk usuwania
            const removeButton = document.createElement("button");
            removeButton.type = "button";
            removeButton.classList.add("remove-row");
            removeButton.textContent = "X";

            removeButton.addEventListener("click", function () {
                wrapper.remove();
                updateAvailableOptions();
                updateIndexes();
                toggleRemoveButtons();
            });

            // Dodanie elementów do wrappera i kontenera
            wrapper.append(selectWrapper, inputWrapper, removeButton);
            container.appendChild(wrapper);

            // Inicjalizacja TomSelect dla nowego selecta
            new TomSelect(select, {
                create: false,
                sortField: "text",
                placeholder: "Wyszukaj..."
            }).setValue("");

            // Nasłuch zmiany w tym selectie
            select.addEventListener("change", updateAvailableOptions);

            input.addEventListener("input", function () {
        if (input.value.trim() !== "") {
            input.classList.add("filled");
        } else {
            input.classList.remove("filled");
        }
    });

    input.addEventListener("blur", function () {
        const validationError = input.closest('.group').querySelector('.input-validation-error');
        if (validationError) {
            // Jeśli pole ma błąd walidacji, nie usuwamy klasy 'filled'
            input.classList.add("filled");
        } else {
            // Używamy tej samej logiki jak w "input", żeby dodać lub usunąć klasę 'filled'
            if (input.value.trim() !== "") {
                input.classList.add("filled");
            } else {
                input.classList.remove("filled");
            }
        }
    });

            updateIndexes();
            updateAvailableOptions();
            toggleRemoveButtons();
        }

        // Funkcja aktualizująca indeksy (dla poprawnego przypisywania nazw)
        function updateIndexes() {
            const allSelects = container.querySelectorAll("select.ingredient-select");
            const allInputs = container.querySelectorAll("input[type='number']");

            allSelects.forEach((select, idx) => {
                select.name = `ActiveIngredients[${idx}].ActiveIngredientId`;
            });
            allInputs.forEach((input, idx) => {
                input.name = `ActiveIngredients[${idx}].Concentration`;
            });
        }
            function toggleRemoveButtons() {
        const removeButtons = container.querySelectorAll(".remove-row");
        const isOnlyOneLeft = removeButtons.length === 1;

        removeButtons.forEach(btn => {
            if (isOnlyOneLeft) {
                btn.style.visibility = "hidden";
                btn.style.opacity = "0";
                btn.style.pointerEvents = "none"; 
            } else {
                btn.style.visibility = "visible";
                btn.style.opacity = "1";
                btn.style.pointerEvents = "auto";
            }
        });
    }
        addIngredientButton.addEventListener("click", createIngredientRow);
        createIngredientRow();
    });
</script>