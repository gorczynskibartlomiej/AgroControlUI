@model AgroControlUI.DTOs.CropProtectionProducts.CreateCropProtectionProductDto

<link rel="stylesheet" href="~/css/add.css" />
<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.css" rel="stylesheet" />
<link rel="stylesheet" href="~/css/addWithSelects.css" />
<link rel="stylesheet" href="~/css/colors.css" />

<style>
    .remove-row {
        background: none;
        border: none;
        color: #28a745; /* Zielony kolor */
        font-size: 24px; /* Duży rozmiar czcionki */
        font-weight: bold;
        cursor: pointer;
        padding: 5px 10px;
        line-height: 1;
    }

    /* Styl dla przycisku "Dodaj kolejny" - dopasowany do stylu action-buttons */
    #add-ingredient {
        display: inline-block;
        background-color: #007bff; /* Główny kolor, np. niebieski */
        color: #fff;
        border: none;
        padding: 10px 20px;
        font-size: 16px;
        font-weight: bold;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.3s ease;
        margin-top: 10px;
    }

        #add-ingredient:hover {
            background-color: #0056b3;
        }



    .adding-wrapper {
        display: flex;
        position: relative;
        align-items: center;
        gap: 10px;
        padding-bottom: 25px;
        justify-content: space-between
    }

        /* Styl dla selecta */
        .adding-wrapper .ts-wrapper {
            position: relative;
            width: 100%;
            border: none;
            border-bottom: 2px #757575 solid;
        }

        /* Styl dla inputa */
        .adding-wrapper .input-wrapper {
            position: relative;
            width: 30%;
            border: none;
            border-bottom: 2px #757575 solid;
        }

        .adding-wrapper .ts-wrapper .ts-control {
            border: none !important;
        }

        .adding-wrapper .input-wrapper input {
            width: 100%;
            border: none;
            background: transparent;
            font-size: 18px;
            outline: none;
            padding: 10px 10px 10px 5px;
            border-bottom: 2px solid #757575;
        }

        .adding-wrapper .input-wrapper .input-bar {
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--main-app-color);
            transform: scaleX(0);
            transition: transform 0.3s ease-in-out;
        }

    .adding-input {
        width: 25%;
    }

    .adding-select {
        width: 60%;
    }

    .adding-wrapper .group {
        margin-bottom: 15px;
    }
</style>

<div class="form-container">
    <div class="green-form">
        <form asp-action="Create" method="post">
            <h1>Dodaj środek ochrony roślin</h1>
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <!-- Nazwa środka -->
            <div class="group">
                <input asp-for="Name" required />
                <span class="bar"></span>
                <label asp-for="Name">Nazwa środka ochrony roślin</label>
                <span asp-validation-for="Name" class="text-danger"></span>
            </div>

            <!-- Producent -->
            <div class="single-dropdown">
                <select asp-for="ProducerId" asp-items="ViewBag.Producers" id="producerSelect">
                    <option value="">Wybierz producenta</option>
                </select>
                <span class="bar"></span>
                <label asp-for="ProducerId">Producent</label>
            </div>

            <!-- Kategorie -->
            <div class="multi-dropdown">
                <select asp-for="CategoryIds" asp-items="ViewBag.Categories" id="categorySelect" multiple></select>
                <span class="bar"></span>
                <label asp-for="CategoryIds">Kategorie</label>
            </div>

            <!-- Rośliny -->
            <div class="multi-dropdown">
                <select asp-for="CropIds" asp-items="ViewBag.Crops" id="cropSelect" multiple></select>
                <span class="bar"></span>
                <label asp-for="CropIds">Rośliny</label>
            </div>

            <!-- Składniki aktywne -->
            <div class="single-dropdown">
                <div id="adding-container" class="adding-container"></div>
                <button type="button" id="add-ingredient">Dodaj kolejny</button>
            </div>

            <!-- Opis -->
            <div class="group">
                <textarea asp-for="Description" class="description-field" required></textarea>
                <span class="bar"></span>
                <label asp-for="Description">Opis</label>
                <span asp-validation-for="Description" class="text-danger"></span>
            </div>

            <div class="action-buttons">
                <a asp-action="Index" class="cancel-btn btn">Anuluj</a>
                <button type="submit" class="add-btn btn">Dodaj</button>
            </div>

        </form>
    </div>
</div>

<!-- Ukryta lista składników aktywnych -->
<select id="componentOptions" style="display:none">
    @foreach (var option in ViewBag.Components)
    {
        <option value="@option.Value">@option.Text</option>
    }
</select>

<script src="~/js/inputLabel.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
<script>
            let isUpdatingOptions = false;

    function getOriginalOptions() {
        const compSelect = document.getElementById("componentOptions");
        return Array.from(compSelect.options).map(opt => ({
            value: opt.value,
            text: opt.text
        }));
    }

    function updateAvailableOptions() {
        // Jeśli już trwa aktualizacja, kończymy
        if (isUpdatingOptions) return;
        isUpdatingOptions = true;

        const originalOptions = getOriginalOptions();
        const allSelects = document.querySelectorAll("select.ingredient-select");

        allSelects.forEach(select => {
            const instance = select.tomselect;
            const currentValue = instance.getValue();
            const selectedValuesOther = new Set();

            allSelects.forEach(s => {
                if (s !== select) {
                    const val = s.tomselect.getValue();
                    if (val !== "") {
                        selectedValuesOther.add(val);
                    }
                }
            });

            // Budujemy nową listę opcji:
            let newOptions = [];
            newOptions.push({ value: "", text: "Wybierz składnik aktywny" });
            originalOptions.forEach(opt => {
                if (!selectedValuesOther.has(opt.value) || opt.value === currentValue) {
                    newOptions.push(opt);
                }
            });

            // Aktualizujemy instancję TomSelect
            instance.clearOptions();
            instance.addOption(newOptions);
            instance.refreshOptions(false);
            if (currentValue !== "") {
                instance.setValue(currentValue);
            } else {
                instance.clear();
            }
        });

        isUpdatingOptions = false;
    }

    // Nasłuchiwanie zmian w selectach ingredient-select
    document.addEventListener("change", (event) => {
        if (event.target.matches("select.ingredient-select")) {
            updateAvailableOptions();
        }
    });

    // Wywołaj updateAvailableOptions() na starcie
    updateAvailableOptions();

    document.addEventListener("DOMContentLoaded", function () {
        // Inicjalizacja TomSelect dla pozostałych dropdownów
        new TomSelect("#producerSelect", { create: false, sortField: "text", placeholder: "Wybierz producenta" });
        new TomSelect("#categorySelect", { create: false, sortField: "text", placeholder: "Wyszukaj...", plugins: ['remove_button'] });
        new TomSelect("#cropSelect", { create: false, sortField: "text", placeholder: "Wyszukaj...", plugins: ['remove_button'] });

        const addIngredientButton = document.getElementById("add-ingredient");
        const container = document.getElementById("adding-container");
        // Pobieranie oryginalnych opcji z ukrytego selecta (jako string, do wstawienia początkowo)
        const componentOptions = document.getElementById("componentOptions").innerHTML;

        // Funkcja tworzenia wiersza składnika
        function createIngredientRow() {
            const wrapper = document.createElement("div");
            wrapper.classList.add("adding-wrapper");

            // Tworzenie selecta dla składnika aktywnego
            const selectWrapper = document.createElement("div");
            selectWrapper.classList.add("group", "adding-select");

            const select = document.createElement("select");
            select.classList.add("ingredient-select");
            select.required = true;
            // Używamy dynamicznie generowanych nazw dla selectów i inputów
            const currentIndex = container.children.length;
            select.name = `ActiveIngredients[${currentIndex}].ActiveIngredientId`;

            console.log(`Tworzę składnik aktywny - Indeks: ${currentIndex}`);
            console.log(`Nazwa dla selecta: ${select.name}`);

            const selectBar = document.createElement("span");
            selectBar.classList.add("bar");

            const selectLabel = document.createElement("label");
            selectLabel.textContent = "Składnik aktywny";

            // Wstawiamy oryginalne opcje wraz z domyślną pustą opcją
            select.innerHTML = `<option value="" selected disabled>Wybierz składnik aktywny</option>` + componentOptions;

            selectWrapper.appendChild(select);
            selectWrapper.appendChild(selectBar);
            selectWrapper.appendChild(selectLabel);

            // Tworzenie inputa dla ilości
            const inputWrapper = document.createElement("div");
            inputWrapper.classList.add("group", "adding-input");

            const input = document.createElement("input");
            input.type = "number";
            input.min = "0";
            input.step = "1";
            input.required = true;
            input.name = `ActiveIngredients[${currentIndex}].Concentration`;

            console.log(`Nazwa dla inputa: ${input.name}`);

            const inputBar = document.createElement("span");
            inputBar.classList.add("bar");

            const inputLabel = document.createElement("label");
            inputLabel.textContent = "Ilość";

            inputWrapper.appendChild(input);
            inputWrapper.appendChild(inputBar);
            inputWrapper.appendChild(inputLabel);

            // Przycisk usuwania
            const removeButton = document.createElement("button");
            removeButton.type = "button";
            removeButton.classList.add("remove-row");
            removeButton.textContent = "X";

            removeButton.addEventListener("click", function () {
                console.log(`Usuwam składnik aktywny - Indeks: ${currentIndex}`);
                wrapper.remove();
                updateAvailableOptions();
                updateIndexes();
            });

            // Dodanie elementów do wrappera i kontenera
            wrapper.append(selectWrapper, inputWrapper, removeButton);
            container.appendChild(wrapper);

            // Inicjalizacja TomSelect dla nowego selecta
            new TomSelect(select, {
                create: false,
                sortField: "text",
                placeholder: "Wyszukaj..."
            }).setValue("");

            // Nasłuch zmiany w tym selectie
            select.addEventListener("change", updateAvailableOptions);

            input.addEventListener("input", function () {
        if (input.value.trim() !== "") {
            input.classList.add("filled");
        } else {
            input.classList.remove("filled");
        }
    });

    input.addEventListener("blur", function () {
        const validationError = input.closest('.group').querySelector('.input-validation-error');
        if (validationError) {
            // Jeśli pole ma błąd walidacji, nie usuwamy klasy 'filled'
            input.classList.add("filled");
        } else {
            // Używamy tej samej logiki jak w "input", żeby dodać lub usunąć klasę 'filled'
            if (input.value.trim() !== "") {
                input.classList.add("filled");
            } else {
                input.classList.remove("filled");
            }
        }
    });

            updateIndexes();
            updateAvailableOptions();
        }

        // Funkcja aktualizująca indeksy (dla poprawnego przypisywania nazw)
        function updateIndexes() {
            const allSelects = container.querySelectorAll("select.ingredient-select");
            const allInputs = container.querySelectorAll("input[type='number']");

            allSelects.forEach((select, idx) => {
                select.name = `ActiveIngredients[${idx}].ActiveIngredientId`;
            });
            allInputs.forEach((input, idx) => {
                input.name = `ActiveIngredients[${idx}].Concentration`;
            });
        }

        addIngredientButton.addEventListener("click", createIngredientRow);
        createIngredientRow();
    });
</script>

@* <script>
        function updateAvailableOptions() {
        // Pobieramy wszystkie wybrane wartości
        const selectedValues = new Set(
            Array.from(document.querySelectorAll("select.ingredient-select"))
                .map(select => select.value)
                .filter(value => value) // Pomijamy puste
        );

        document.querySelectorAll("select.ingredient-select").forEach(select => {
            // Pobieramy wszystkie opcje w danym selekcie
            Array.from(select.options).forEach(option => {
                // Jeśli opcja jest już wybrana w innym selekcie, ukrywamy ją
                if (selectedValues.has(option.value) && option.value !== select.value) {
                    option.hidden = true;
                } else {
                    option.hidden = false;
                }
            });
        });
    }

    // Nasłuchiwanie zmian w selectach
    document.addEventListener("change", (event) => {
        if (event.target.matches("select.ingredient-select")) {
            updateAvailableOptions();
        }
    });

    // Wywołaj na starcie i po dodaniu nowego składnika
    updateAvailableOptions();
            document.addEventListener("DOMContentLoaded", function () {
        // Inicjalizacja TomSelect dla dropdownów
        new TomSelect("#producerSelect", { create: false, sortField: "text", placeholder: "Wybierz producenta" });
        new TomSelect("#categorySelect", { create: false, sortField: "text", placeholder: "Wyszukaj...", plugins: ['remove_button'] });
        new TomSelect("#cropSelect", { create: false, sortField: "text", placeholder: "Wyszukaj...", plugins: ['remove_button'] });

        const addIngredientButton = document.getElementById("add-ingredient");
        const container = document.getElementById("adding-container");

        // Pobieranie opcji składników z ukrytego selecta
        const componentOptions = document.getElementById("componentOptions").innerHTML;

        // Funkcja tworzenia wiersza składnika
        function createIngredientRow() {
            const wrapper = document.createElement("div");
            wrapper.classList.add("adding-wrapper");

            // Select składnika aktywnego
            const selectWrapper = document.createElement("div");
            selectWrapper.classList.add("group");
            selectWrapper.classList.add("adding-select");

            const select = document.createElement("select");
            select.classList.add("ingredient-select");
            select.required = true;
            // Używamy dynamicznie generowanych nazw dla selectów i inputów
            const currentIndex = container.children.length;  // Pobieramy aktualny indeks na podstawie liczby dzieci w kontenerze
            select.name = `ActiveIngredients[${currentIndex}].ActiveIngredientId`; // Zmieniamy indeks na aktualny

            console.log(`Tworzę składnik aktywny - Indeks: ${currentIndex}`);
            console.log(`Nazwa dla selecta: ${select.name}`);  // Logujemy nazwę pola dla selecta

            const selectBar = document.createElement("span");
            selectBar.classList.add("bar");

            const selectLabel = document.createElement("label");
            selectLabel.textContent = "Składnik aktywny";

            // Wstawienie opcji składników z ukrytego elementu
            select.innerHTML = componentOptions;

            selectWrapper.appendChild(select);
            selectWrapper.appendChild(selectBar);
            selectWrapper.appendChild(selectLabel);

            // Input ilości składnika
            const inputWrapper = document.createElement("div");
            inputWrapper.classList.add("group");
            inputWrapper.classList.add("adding-input");

            const input = document.createElement("input");
            input.type = "number";
            input.min = "0";
            input.step = "1";
            input.required = true;

            // Dynamiczne nadawanie nazw dla inputów
            input.name = `ActiveIngredients[${currentIndex}].Concentration`; // Zmieniamy indeks na aktualny

            console.log(`Nazwa dla inputa: ${input.name}`);  // Logujemy nazwę pola dla inputa

            const inputBar = document.createElement("span");
            inputBar.classList.add("bar");

            const inputLabel = document.createElement("label");
            inputLabel.textContent = "Ilość";

            inputWrapper.appendChild(input);
            inputWrapper.appendChild(inputBar);
            inputWrapper.appendChild(inputLabel);

            // Przycisk usuwania
            const removeButton = document.createElement("button");
            removeButton.type = "button";
            removeButton.classList.add("remove-row");
            removeButton.textContent = "X";

            removeButton.addEventListener("click", function () {
                console.log(`Usuwam składnik aktywny - Indeks: ${currentIndex}`);
                wrapper.remove();  // Usuwanie składnika z formularza
                updateIndexes(); // Aktualizujemy indeksy po usunięciu składnika
            });

            // Dodanie składnika do formularza
            wrapper.appendChild(selectWrapper);
            wrapper.appendChild(inputWrapper);
            wrapper.appendChild(removeButton);
            container.appendChild(wrapper);

            // Inicjalizacja TomSelect dla nowego selecta
            new TomSelect(select, {
                create: false,
                sortField: "text",
                placeholder: "Wyszukaj..."
            }).setValue("");

            // Zaktualizuj indeksy po dodaniu składnika
            updateIndexes();
        }

        // Funkcja do aktualizacji indeksów
            function updateIndexes() {
        const allSelects = container.querySelectorAll("select.ingredient-select");
        const allInputs = container.querySelectorAll("input[type='number']");

        console.log("Aktualizuję indeksy...");
        console.log("Liczba selectów:", allSelects.length);
        console.log("Liczba inputów:", allInputs.length);
            console.log("Lista selectów w kontenerze:");
    allSelects.forEach((select, idx) => {
        console.log(`Select ${idx}:`, select, "Name:", select.name);
        console.log("Czy drugi select istnieje w DOM-ie?", document.body.contains(allSelects[1]));
    });

        allSelects.forEach((select, idx) => {
            console.log(`Select ${idx}: ${select ? select.name : "undefined"}`);
        });

        allInputs.forEach((input, idx) => {
            console.log(`Input ${idx}: ${input ? input.name : "undefined"}`);
        });

        allSelects.forEach((select, idx) => {
            if (select) {
                const oldName = select.name;
                select.name = `ActiveIngredients[${idx}].ActiveIngredientId`;
                console.log(`Zmieniam nazwę selecta: ${oldName} → ${select.name}`);
            } else {
                console.log(`BŁĄD: Select ${idx} jest undefined!`);
            }
        });

        allInputs.forEach((input, idx) => {
            if (input) {
                const oldName = input.name;
                input.name = `ActiveIngredients[${idx}].Concentration`;
                console.log(`Zmieniam nazwę inputa: ${oldName} → ${input.name}`);
            } else {
                console.log(`BŁĄD: Input ${idx} jest undefined!`);
            }
        });
    }


        // Obsługa przycisku dodawania składnika
        addIngredientButton.addEventListener("click", createIngredientRow);

        // Początkowe wywołanie do utworzenia pierwszego składnika
        createIngredientRow();
    });

</script> *@