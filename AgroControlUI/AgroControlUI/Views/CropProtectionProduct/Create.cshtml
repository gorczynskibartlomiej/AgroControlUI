@model AgroControlUI.DTOs.CropProtectionProducts.CreateCropProtectionProductDto

<link rel="stylesheet" href="~/css/add.css" />
<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.css" rel="stylesheet" />
<link rel="stylesheet" href="~/css/addWithSelects.css" />
<link rel="stylesheet" href="~/css/colors.css" />
<style>


    .adding-dropdown {
        position: relative;
        margin-bottom: 60px;
        margin-top: -10px;
        min-height: 40px;
        border: none;
    }

        .adding-dropdown label {
            display: block !important;
            margin-bottom: 5px;
            color: #999 !important;
            font-size: 18px;
            font-weight: normal;
            position: absolute;
            pointer-events: none;
            left: 5px;
            top: 10px;
            transition: 0.2s ease all;
            z-index: 10;
        }






    .adding-wrapper {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
    }

        .adding-wrapper .ts-wrapper {
            width: 65%;
        }

        .adding-wrapper input {
            width: 20%;
        }

        .adding-wrapper.ts-wrapper.input-active ~ .bar:before, .adding-wrapper.ts-wrapper.input-active ~ .bar:after {
            width: 50%;
        }

        .adding-wrapper .ts-wrapper .ts-control {
            display: flex;
            padding: 10px 10px 10px 5px;
            min-height: 40px;
            background-color: white;
            border: none;
            flex-wrap: nowrap;
        }

            .adding-wrapper .ts-wrapper .ts-control .item {
                background-color: transparent !important;
                color: black !important;
                pointer-events: none;
                display: flex;
                font-size: 18px;
                padding: 0;
                margin: 0;
            }

            .adding-wrapper .ts-wrapper .ts-control .remove {
                display: none;
            }

            .adding-wrapper .ts-wrapper .ts-control input {
                flex-grow: 1;
                min-width: 100px;
                border: none;
                background: transparent;
                font-size: 18px;
                outline: none;
                padding: 0px;
            }
</style>
<div class="form-container">
    <div class="green-form">
        <form asp-action="Create" method="post">
            <h1>Dodaj środek ochrony roślin</h1>
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <!-- Nazwa środka -->
            <div class="group">
                <input asp-for="Name" required />
                <span class="bar"></span>
                <label asp-for="Name">Nazwa środka ochrony roślin</label>
                <span asp-validation-for="Name" class="text-danger"></span>
            </div>

            <!-- Producent -->
            <div class="single-dropdown">
                <select asp-for="ProducerId" asp-items="ViewBag.Producers" id="producerSelect">
                    <option value="">Wybierz producenta</option>
                </select>
                <span class="bar"></span>
                <label asp-for="ProducerId">Producent</label>
            </div>

            <!-- Kategorie -->
            <div class="multi-dropdown">
                <select asp-for="CategoryIds" asp-items="ViewBag.Categories" id="categorySelect" multiple></select>
                <span class="bar"></span>
                <label asp-for="CategoryIds">Kategorie</label>
            </div>

            <!-- Rośliny -->
            <div class="multi-dropdown">
                <select asp-for="CropIds" asp-items="ViewBag.Crops" id="cropSelect" multiple></select>
                <span class="bar"></span>
                <label asp-for="CropIds">Rośliny</label>
            </div>

            <!-- Składniki aktywne -->
            <div class="adding-dropdown">
                <div id="adding-container" class="adding-container"></div>
                <label>Składniki aktywne</label>
                <button type="button" id="add-ingredient">Dodaj kolejny</button>
            </div>

            <!-- Opis -->
            <div class="group">
                <textarea asp-for="Description" class="description-field" required></textarea>
                <span class="bar"></span>
                <label asp-for="Description">Opis</label>
                <span asp-validation-for="Description" class="text-danger"></span>
            </div>

            <div class="action-buttons">
                <a asp-action="Index" class="cancel-btn btn">Anuluj</a>
                <button type="submit" class="add-btn btn">Dodaj</button>
            </div>
        </form>
    </div>
</div>

<!-- Ukryta lista składników aktywnych -->
<select id="componentOptions" style="display:none">
    @foreach (var option in ViewBag.Components)
    {
        <option value="@option.Value">@option.Text</option>
    }
</select>

<script src="~/js/inputLabel.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        new TomSelect("#producerSelect", { create: false, sortField: "text", placeholder: "Wybierz producenta" });
        new TomSelect("#categorySelect", { create: false, sortField: "text", placeholder: "Wyszukaj...", plugins: ['remove_button'] });
        new TomSelect("#cropSelect", { create: false, sortField: "text", placeholder: "Wyszukaj...", plugins: ['remove_button'] });

        const addIngredientButton = document.getElementById("add-ingredient");
        const container = document.getElementById("adding-container");
        let selectedIngredients = new Set();
        let ingredientSelects = [];

        function updateDropdownOptions() {
            ingredientSelects.forEach(select => {
                const currentValue = select.getValue();
                select.clear();
                select.clearOptions();

                document.querySelectorAll("#componentOptions option").forEach(option => {
                    if (!selectedIngredients.has(option.value) || option.value === currentValue) {
                        select.addOption({ value: option.value, text: option.textContent });
                    }
                });

                if (currentValue) select.setValue(currentValue, true);
            });
        }

        function updateIngredientIndices() {
            const wrappers = container.querySelectorAll(".adding-wrapper");
            wrappers.forEach((wrapper, index) => {
                const select = wrapper.querySelector("select");
                const input = wrapper.querySelector("input[type='number']");
                select.name = ActiveIngredients[${index}].ActiveIngredientId;
                input.name = ActiveIngredients[${index}].Concentration;
            });
        }

        function createIngredientRow() {
            const wrapper = document.createElement("div");
            wrapper.classList.add("adding-wrapper");

            const select = document.createElement("select");
            select.classList.add("ingredient-select");
            select.innerHTML = document.getElementById("componentOptions").innerHTML;

            const input = document.createElement("input");
            input.type = "number";
            input.placeholder = "Ilość";
            input.min = "0";
            input.step = "1";

            const removeButton = document.createElement("button");
            removeButton.type = "button";
            removeButton.classList.add("remove-row");
            removeButton.textContent = "X";

            removeButton.addEventListener("click", function () {
                selectedIngredients.delete(select.tomselect.getValue());
                ingredientSelects = ingredientSelects.filter(s => s !== select.tomselect);
                wrapper.remove();
                updateDropdownOptions();
                updateIngredientIndices();
            });

            wrapper.appendChild(select);
            wrapper.appendChild(input);
            wrapper.appendChild(removeButton);
            container.appendChild(wrapper);

            const ts = new TomSelect(select, {
                create: false,
                sortField: "text",
                placeholder: "Wybierz składnik...",
                plugins: ['remove_button'],
                onChange: function (value) {
                    selectedIngredients.add(value);
                    updateDropdownOptions();
                }
            });

            ingredientSelects.push(ts);
            updateDropdownOptions();
            updateIngredientIndices();
        }

        addIngredientButton.addEventListener("click", createIngredientRow);
        createIngredientRow();
    });
</script>