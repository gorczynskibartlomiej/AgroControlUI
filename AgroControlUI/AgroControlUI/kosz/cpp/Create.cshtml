@model AgroControlUI.DTOs.CropProtectionProducts.CreateCropProtectionProductDto

<link rel="stylesheet" href="~/css/add.css">
<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.css" rel="stylesheet">
<link rel="stylesheet" href="~/css/colors.css" />
<style>
    .ts-wrapper {
        border: 2px solid #757575;
        border-radius: 8px;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

        .ts-wrapper.input-active {
            border-color: #4caf50 !important;
            outline: none;
        }

    .ts-control {
        border: none;
        border-radius: 8px;
        padding: 10px;
        font-size: 16px;
        background-color: white;
    }

    .ts-dropdown {
        border: 2px solid #4caf50;
        border-radius: 8px;
        background-color: white;
        overflow: hidden;
    }

        .ts-dropdown .option {
            padding: 10px;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

    .ts-control::before {
        content: attr(data-placeholder);
        color: #757575;
        position: absolute;
        left: 10px;
        pointer-events: none;
        display: block;
    }

    .ts-dropdown .option:hover {
        background-color: #4caf50;
        color: white;
    }

    .ts-control .item {
        background-color: #4caf50 !important;
        color: white !important;
        border-radius: 5px;
        padding: 5px 5px !important;
        margin: 8px;
        display: flex;
        align-items: center;
        font-size: 16px;
        pointer-events: none;
    }

        .ts-control .item .remove {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            font-size: 22px;
            margin-left: 0px;
            cursor: pointer;
            background-color: #4caf50 !important;
            pointer-events: auto;
            cursor: pointer;
        }

            .ts-control .item .remove:hover {
                background-color: #4caf50 !important;
                color: black;
            }

            .ts-control .item .remove::before {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100%;
                height: 100%;
            }

    .ts-wrapper.plugin-remove_button:not(.rtl) .item {
        padding-right: 5px !important;
    }
    /* Stylowanie kontrolki z wieloma opcjami */
    .ts-control {
        background-color: white;
        border: none; /* Usunięcie obramowania */
        border-radius: 8px;
        padding: 10px;
        font-size: 16px;
    }

    /* Stylowanie dropdowna */
    .ts-dropdown {
        border: 2px solid #4caf50;
        border-radius: 8px;
        background-color: white;
        overflow: hidden;
        box-shadow: none;
    }

        /* Stylowanie opcji w dropdownie */
        .ts-dropdown .option {
            padding: 10px;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

            /* Kolorowanie opcji przy najechaniu */
            .ts-dropdown .option:hover {
                background-color: #4caf50;
                color: white;
            }

    .group-dropdown {
        position: relative;
        margin-bottom: 40px;
        margin-top: -10px;
        min-height: 40px
    }

    #producerSelect + .ts-wrapper .ts-control {
        display: block;
        padding: 10px;
        min-height: 40px;
        background-color: white;
    }

        #producerSelect + .ts-wrapper .ts-control .item {
            background-color: transparent !important;
            color: black !important;
            pointer-events: none;
            display: block;
            font-size: 16px;
            padding: 0;
            margin: 0;
        }

        #producerSelect + .ts-wrapper .ts-control .remove {
            display: none;
        }

    .ts-dropdown [data-selectable] .highlight {
        background: none;
        font-weight: bold;
        font-size: 16px;
        transition: background-color 0.3s ease;
        opacity: 1;
        display: inline;
        position: unset !important;
    }

    /* Styl scrollbara dla WebKit (Chrome, Edge, Safari) */
    .ts-dropdown-content::-webkit-scrollbar {
        width: 12px;
    }

    .ts-dropdown-content::-webkit-scrollbar-track {
        border-radius: 8px;
        background-color: #e7e7e7;
        border: 1px solid #cacaca;
        box-shadow: inset 0 0 6px rgba(0, 0, 0, .3);
    }

    .ts-dropdown-content::-webkit-scrollbar-thumb {
        border-radius: 8px;
        background-color: #363636;
    }

</style>
<div class="form-container">
    <div class="green-form">
        <form asp-action="Create" method="post">
            <h1>Dodaj środek ochrony roślin</h1>
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <div class="group">
                <input asp-for="Name" required />
                
                <span class="bar"></span>
                <label asp-for="Name">Nazwa środka ochrony roślin</label>
                <span asp-validation-for="Name" class="text-danger"></span>
            </div>
            <div class="group">
                <textarea asp-for="Description" class="description-field" required></textarea>
                
                <span class="bar"></span>
                <label asp-for="Description">Opis</label>
                <span asp-validation-for="Description" class="text-danger"></span>
            </div>
            <!-- Pole wyboru producenta i kategorii -->
            <div class="group">
                <label asp-for="ProducerId">Producent</label>
                <select asp-for="ProducerId" asp-items="ViewBag.Producers" id="producerSelect">
                    <option value="">Wybierz producenta</option>
                </select>

            </div>            
            <div class="group-dropdown">
                <label asp-for="CategoryIds">Kategorie</label>
                <select asp-for="CategoryIds" asp-items="ViewBag.Categories" id="categorySelect" multiple>
                </select>
            </div>
            <div class="group-dropdown">
                <label asp-for="CropIds">Rośliny</label>
                <select asp-for="CropIds" asp-items="ViewBag.Crops" id="cropSelect" multiple>
                </select>
            </div>
            <!-- Aktywne składniki z ilością -->
            <div class="group-dropdown">
                <label>Składniki aktywne</label>
                <div id="active-ingredients-container">
                    <!-- Pierwszy wiersz -->
                    <div class="active-ingredient-row">
                        <select name="ActiveIngredients[0].ComponentId" class="component-select">
                            <option value="">Wybierz składnik aktywny</option>
                            @foreach (var item in ViewBag.Components as List<SelectListItem>)
                            {
                                <option value="@item.Value">@item.Text</option>
                            }
                        </select>
                        <input type="number" name="ActiveIngredients[0].QuantityInGrams" placeholder="Ilość (g)" step="0.01" required />
                        <button type="button" class="remove-ingredient" style="display: none;">Usuń</button>
                    </div>
                </div>
                <button type="button" id="add-active-ingredient" class="add-btn btn" style="width: auto;">Dodaj składnik</button>
            </div>
            <!-- Przyciski akcji -->
            <div class="action-buttons">
                <a asp-action="Index" class="cancel-btn btn">Anuluj</a>
                <button type="submit" class="add-btn btn">Dodaj</button>
            </div>
        </form>
    </div>
</div>

<!-- TomSelect JS -->
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Inicjalizacja TomSelect dla producenta, kategorii, roślin
        // new TomSelect("#producerSelect", {
        //     create: false,
        //     sortField: { field: "text", direction: "asc" },
        //     placeholder: "Wybierz lub wyszukaj producenta",
        //     searchField: "text",
        //     hideSelected: true,
        //     allowEmptyOption: false
        // });
            new TomSelect("#producerSelect",{
        create: false,
        sortField: {
            field: "text",
            direction: "asc"
        }
    });
        new TomSelect("#categorySelect", {
            create: false,
            sortField: { field: "text", direction: "asc" },
            placeholder: "Wybierz lub wyszukaj kategorie",
            maxItems: null,
            plugins: ['remove_button'],
            searchField: "text"
        });

        new TomSelect("#cropSelect", {
            create: false,
            sortField: { field: "text", direction: "asc" },
            placeholder: "Wybierz lub wyszukaj rośliny",
            maxItems: null,
            plugins: ['remove_button'],
            searchField: "text"
        });

        // Inicjalizacja TomSelect dla składników aktywnych - dla każdego wiersza będziemy inicjalizować osobno
        initializeComponentSelects();

        // Obsługa dodawania kolejnych wierszy
        var container = document.getElementById("active-ingredients-container");
        var addBtn = document.getElementById("add-active-ingredient");

        addBtn.addEventListener("click", function () {
            var index = container.children.length; // Nowy indeks
            var newRow = document.createElement("div");
            newRow.classList.add("active-ingredient-row");
            newRow.innerHTML = `
                <select name="ActiveIngredients[${index}].ComponentId" class="component-select">
                    <option value="">Wybierz składnik aktywny</option>
    @foreach (var item in ViewBag.Components as List<SelectListItem>)
    {
        <text><option value="@item.Value">@item.Text</option></text>
    }
                </select>
                <input type="number" name="ActiveIngredients[${index}].QuantityInGrams" placeholder="Ilość (g)" step="0.01" required />
                <button type="button" class="remove-ingredient">Usuń</button>
            `;
            container.appendChild(newRow);
            // Inicjalizujemy TomSelect dla nowo dodanego selecta
            new TomSelect(newRow.querySelector(".component-select"), {
                create: false,
                sortField: { field: "text", direction: "asc" },
                placeholder: "Wybierz składnik aktywny",
                searchField: "text",
                hideSelected: true
            });
            // Ustawiamy widoczność przycisku usuwania, jeśli więcej niż jeden wiersz
            updateRemoveButtons();
        });

        // Funkcja do aktualizacji widoczności przycisków usuwania
        function updateRemoveButtons() {
            var rows = document.querySelectorAll(".active-ingredient-row");
            rows.forEach(function (row, idx) {
                var removeBtn = row.querySelector(".remove-ingredient");
                // Pokaż przycisk, jeśli jest więcej niż jeden wiersz
                if (rows.length > 1) {
                    removeBtn.style.display = "inline-block";
                } else {
                    removeBtn.style.display = "none";
                }
                // Opcjonalnie: można też dodać numerację lub zmienić nazwy pól, jeśli to potrzebne
            });
        }

        // Obsługa usuwania wiersza
        document.getElementById("active-ingredients-container").addEventListener("click", function (e) {
            if (e.target && e.target.classList.contains("remove-ingredient")) {
                e.target.parentElement.remove();
                updateRemoveButtons();
                // Możesz też zaktualizować indeksy nazw pól, jeśli to konieczne
            }
        });

        // Inicjalizacja TomSelect dla już istniejących wierszy
        function initializeComponentSelects() {
            var componentSelects = document.querySelectorAll(".component-select");
            componentSelects.forEach(function (select) {
                new TomSelect(select, {
                    create: false,
                    sortField: { field: "text", direction: "asc" },
                    placeholder: "Wybierz składnik aktywny",
                    searchField: "text",
                    hideSelected: true
                });
            });
        }
    });
</script>
